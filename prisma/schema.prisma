// Offsets - Collaborative Literary Project
// Database schema for nodes and their tree structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Iteration {
  id          String   @id @default(cuid())
  name        String   // e.g., "Iteration 1", "Spring 2025"
  description String?  // Optional description
  startDate   DateTime @default(now())
  endDate     DateTime? // When iteration was concluded
  isActive    Boolean  @default(true)

  nodes       Node[]

  @@index([isActive])
}

model Node {
  id        String   @id @default(cuid())
  content   String   // The literary content (no length limit)
  authorName String  // Player's name (hidden until withered)

  // Node lifecycle
  status    NodeStatus @default(PENDING)
  createdAt DateTime   @default(now())
  publishedAt DateTime? // When admin approved and published

  // Tree structure
  parentId  String?
  parent    Node?   @relation("NodeToNode", fields: [parentId], references: [id])
  children  Node[]  @relation("NodeToNode")

  // Withering tracking
  lastResponseAt DateTime? // Last time a child was added
  witheredAt     DateTime? // When node died (3 days no responses)

  // Iteration tracking
  iterationId String
  iteration   Iteration @relation(fields: [iterationId], references: [id])

  @@index([status])
  @@index([parentId])
  @@index([publishedAt])
  @@index([iterationId])
}

enum NodeStatus {
  PENDING    // Awaiting admin approval
  LIVE       // Published and can receive responses
  WITHERED   // Died (no responses for 3 days), author revealed
  REJECTED   // Admin rejected (optional, for future use)
}

model SiteSettings {
  id                String   @id @default("default")

  // Hero section
  heroTitle         String   @default("Offsets")
  heroSubtitle      String   @default("A collaborative literary project where nodes of creative writing branch and grow like a tree")

  // How It Works section - now dynamic JSON arrays
  howItWorksTitle   String   @default("How It Works")
  steps             Json     @default("[{\"title\":\"1. Read & Respond\",\"description\":\"Browse live nodes and respond with your own creative writing. Your response can be any length and connect to the parent node through linguistic, conceptual, formal, or stylistic links.\"},{\"title\":\"2. Stay Anonymous\",\"description\":\"Your name stays hidden until your node \\\"withers\\\" - when it receives no responses for 3 days. This keeps the focus on the writing itself.\"},{\"title\":\"3. Branch & Grow\",\"description\":\"Each response creates a new branch in the tree. Multiple people can respond to the same node, creating a network of interconnected creative writing.\"},{\"title\":\"4. Admin Approval\",\"description\":\"All submissions are reviewed before publishing to maintain quality and intention. Once approved, your node goes live immediately.\"}]")

  // Rules section - now dynamic JSON array
  rulesTitle        String   @default("The Rules")
  rules             Json     @default("[\"Any length: Your node can be a single word or a lengthy piece - there's no character limit.\",\"Any connection: Link to your parent node however you see fit - thematically, formally, linguistically, or conceptually.\",\"Withering period: If a live node receives no responses for 3 days, it \\\"withers\\\" and the author's name is revealed.\",\"No responses to withered nodes: Once a node has withered, it can no longer receive new responses.\",\"Submit your name: Enter your name with each submission - it will be revealed when your node withers.\"]")

  // Contribution page section
  contributionHeading        String   @default("Respond to this node")
  contributionWitheredMessage String  @default("This node has withered and can no longer receive responses.")

  updatedAt         DateTime @updatedAt
}
